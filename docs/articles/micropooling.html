<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Micropooling and VISION • VISION</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Micropooling and VISION">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">VISION</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.99.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/VISION-vignette.html">Introduction to VISION</a>
    </li>
    <li>
      <a href="../articles/micropooling.html">Micropooling and VISION</a>
    </li>
    <li>
      <a href="../articles/trajectories.html">Trajectory Inference and VISION</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Micropooling and VISION</h1>
                        <h4 class="author">Matthew Jones</h4>
            
            <h4 class="date">7 November 2018</h4>
      
      
      <div class="hidden name"><code>micropooling.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>To accommodate datasets that exceed available memory and CPU resources, VISION creates pooled cells using a custom micropooling algorithm. In standard use cases, the users provide the entire expression matrix and VISION will create pooled cells with the user-defined cellsPerPartition argument as supplied to the VISION object constructor. Analysis will resume on the pooled data matrix, where each pooled cell has at most cellsPerPartition cells per pool. We find that this drastically reduces the run time, producing results from 500K cells in just under around an hour. We also find that the local autocorrelation scores run in the latent space as computed from the pooled cells is consistent with that when these scores are computed from the entire dataset.</p>
</div>
<div id="the-algorithm" class="section level1">
<h1 class="hasAnchor">
<a href="#the-algorithm" class="anchor"></a>The Algorithm</h1>
<p>The micropooling algorithm relies on iterative clustering of the latent space. Specifically, given an expression matrix and a cellsPerPartition target size, we use the following procedure:</p>
<ul>
<li>Form a latent space using the first 30 Principal Components</li>
<li>Compute a KNN graph, where edge weights are determined by applying a Gaussian kernel to the euclidean distances in PC space</li>
<li>Perform Louvain Clustering on KNN graph</li>
<li>Iteratively perform K-means clustering within the louvain clusters until we have at most cellsPerPartition cells per cluster.</li>
<li>Collapse cells into pooled cells by computing the gene-wise mean for all cells in each cluster.</li>
</ul>
<p>By default, VISION does not allow micropooling within discrete classes (e.g. cell types, or batch) as we find that unbiased clusterings are the most sensible and reflective of the data. Instead, in the output report, pooled cells report their percent consistency of each discrete meta data item (e.g. a pooled cell is 80% CD4+ T cell and 20% CD8+ T cell). In this way, users may develop an intuition of the phenotype of each pooled cell. To note, users may also elect to perform clusterings outside of the VISION analysis pipeline and provide it to the VISION object constructor as pooled data - this allows users to perform micorclustering within discrete classes if they so wish.</p>
</div>
<div id="the-data" class="section level1">
<h1 class="hasAnchor">
<a href="#the-data" class="anchor"></a>The Data</h1>
<p>In this vignette, we’ll be analyzing a set of ~5,000 cells during haematopoiesis (<a href="https://www.nature.com/articles/nature25741">Tusi et al, Nature 2018</a>).</p>
</div>
<div id="workflow" class="section level1">
<h1 class="hasAnchor">
<a href="#workflow" class="anchor"></a>Workflow</h1>
<p>You’ll only need VISION installed for this example, which can be installed as such:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"YosefLab/VISION"</span>)</a></code></pre></div>
<p>Now, we’ll demonstrate a very common use case of micropooling on the data:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">library</span>(VISION)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">counts =<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">read.table</span>(<span class="st">"data/hemato_counts.csv.gz"</span>, <span class="dt">sep=</span><span class="st">','</span>, <span class="dt">header=</span>T, <span class="dt">row.names=</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co"># compute scaled counts</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">scale.factor =<span class="st"> </span><span class="kw">median</span>(<span class="kw">colSums</span>(counts))</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">scaled.counts =<span class="st"> </span><span class="kw">t</span>(<span class="kw">t</span>(counts) <span class="op">/</span><span class="st"> </span><span class="kw">colSums</span>(counts)) <span class="op">*</span><span class="st"> </span>scale.factor</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co"># perform preliminary Fano filtering to determing projection genes, as usual</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">f.genes =<span class="st"> </span>VISION<span class="op">:::</span><span class="kw"><a href="../reference/filterGenesFano.html">filterGenesFano</a></span>(scaled.counts)</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co"># read in meta data </span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">meta =<span class="st"> </span><span class="kw">read.table</span>(<span class="st">"data/hemato_covariates.txt.gz"</span>, <span class="dt">sep=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dt">header=</span>T, <span class="dt">row.names=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">meta =<span class="st"> </span>meta[<span class="kw">colnames</span>(scaled.counts), <span class="dv">-1</span>]</a>
<a class="sourceLine" id="cb2-15" data-line-number="15"></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">vis &lt;-<span class="st"> </span><span class="kw"><a href="../reference/VISION-class.html">Vision</a></span>(scaled.counts, </a>
<a class="sourceLine" id="cb2-17" data-line-number="17">              <span class="kw">c</span>(<span class="st">"data/h.all.v5.2.symbols.gmt"</span>),</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">              <span class="dt">pool=</span>T, </a>
<a class="sourceLine" id="cb2-19" data-line-number="19">              <span class="dt">cellsPerPartition=</span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">              <span class="dt">projection_genes =</span> f.genes, </a>
<a class="sourceLine" id="cb2-21" data-line-number="21">              <span class="dt">meta=</span>meta)</a>
<a class="sourceLine" id="cb2-22" data-line-number="22"></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">vis &lt;-<span class="st"> </span><span class="kw"><a href="../reference/analyze-Vision-method.html">analyze</a></span>(vis)</a>
<a class="sourceLine" id="cb2-24" data-line-number="24"></a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="kw"><a href="../reference/viewResults.html">viewResults</a></span>(vis)</a></code></pre></div>
<p>Often times, there are discrete classes that users may not wish to break out of when micropooling (e.g. they may not want to mix cells from disease and control cases). If this is the case, you may preform micropooling outside of the analysis pipeline and pass it in as such:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">cellsPerPartition =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">meta<span class="op">$</span>GRvsER =<span class="st"> </span><span class="kw">as.factor</span>(<span class="kw">sapply</span>(meta<span class="op">$</span>ct, <span class="cf">function</span>(x) <span class="kw">ifelse</span>((x <span class="op">==</span><span class="st"> "BA"</span> <span class="op">||</span><span class="st"> </span>x <span class="op">==</span><span class="st"> "ER"</span> <span class="op">||</span><span class="st"> </span>x <span class="op">==</span><span class="st"> "MK"</span>), <span class="st">"ErLin"</span>, <span class="st">"GrLin"</span>)))</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">meta.var =<span class="st"> </span>meta[,<span class="st">"GRvsER"</span>, drop=F]</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">all.pools =<span class="st"> </span><span class="kw">sapply</span>(<span class="kw">levels</span>(meta.var<span class="op">$</span>GRvsER), <span class="cf">function</span>(x) { </a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    <span class="kw">print</span>(x)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    cells =<span class="st"> </span><span class="kw">rownames</span>(meta.var)[meta.var[,<span class="dv">1</span>] <span class="op">==</span><span class="st"> </span>x]</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    pools =<span class="st"> </span>VISION<span class="op">:::</span><span class="kw"><a href="../reference/applyMicroClustering.html">applyMicroClustering</a></span>(scaled.counts[, cells],</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">                              <span class="dt">cellsPerPartition=</span>cellsPerPartition,</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">                              <span class="dt">filterInput =</span> f.genes,</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">                              <span class="dt">filterThreshold =</span> <span class="fl">0.1</span>,</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">                              <span class="dt">preserve_clusters =</span> <span class="ot">NULL</span>, </a>
<a class="sourceLine" id="cb3-14" data-line-number="14">                              <span class="dt">latentSpace =</span> <span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">    </a>
<a class="sourceLine" id="cb3-16" data-line-number="16">    nn &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(pools), <span class="cf">function</span>(y) <span class="kw">paste0</span>(x, <span class="st">".microcluster"</span>, y))</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb3-18" data-line-number="18">    <span class="kw">names</span>(pools) &lt;-<span class="st"> </span>nn</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">    <span class="kw">return</span>(pools)</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">    </a>
<a class="sourceLine" id="cb3-21" data-line-number="21">  })</a>
<a class="sourceLine" id="cb3-22" data-line-number="22"></a>
<a class="sourceLine" id="cb3-23" data-line-number="23">all.pools =<span class="st"> </span><span class="kw">unlist</span>(all.pools, <span class="dt">recursive=</span>F)</a>
<a class="sourceLine" id="cb3-24" data-line-number="24"></a>
<a class="sourceLine" id="cb3-25" data-line-number="25">vis &lt;-<span class="st"> </span><span class="kw"><a href="../reference/VISION-class.html">Vision</a></span>(scaled.counts, </a>
<a class="sourceLine" id="cb3-26" data-line-number="26">              <span class="kw">c</span>(<span class="st">"data/h.all.v5.2.symbols.gmt"</span>),</a>
<a class="sourceLine" id="cb3-27" data-line-number="27">              <span class="dt">projection_genes =</span> f.genes, </a>
<a class="sourceLine" id="cb3-28" data-line-number="28">              <span class="dt">meta=</span>meta, </a>
<a class="sourceLine" id="cb3-29" data-line-number="29">              <span class="dt">pools =</span> all.pools)</a>
<a class="sourceLine" id="cb3-30" data-line-number="30"></a>
<a class="sourceLine" id="cb3-31" data-line-number="31">vis &lt;-<span class="st"> </span><span class="kw"><a href="../reference/analyze-Vision-method.html">analyze</a></span>(vis)</a></code></pre></div>
</div>
<div id="session-info" class="section level1">
<h1 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session Info</h1>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">sessionInfo</span>()</a></code></pre></div>
<pre><code>## R version 3.5.1 (2018-07-02)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 16.04.4 LTS
## 
## Matrix products: default
## BLAS/LAPACK: /data/yosef2/users/david.detomaso/programs1604/lib/libopenblas_genericp-r0.3.2.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] BiocStyle_2.8.2
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.0       knitr_1.20       xml2_1.2.0       magrittr_1.5    
##  [5] roxygen2_6.1.0   MASS_7.3-50      R6_2.2.2         rlang_0.2.1     
##  [9] stringr_1.3.1    tools_3.5.1      xfun_0.3         htmltools_0.3.6 
## [13] commonmark_1.5   yaml_2.2.0       rprojroot_1.3-2  digest_0.6.15   
## [17] assertthat_0.2.0 bookdown_0.7     pkgdown_1.1.0    crayon_1.3.4    
## [21] fs_1.2.6         memoise_1.1.0    evaluate_0.11    rmarkdown_1.10  
## [25] stringi_1.2.4    compiler_3.5.1   desc_1.2.0       backports_1.1.2</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#the-algorithm">The Algorithm</a></li>
      <li><a href="#the-data">The Data</a></li>
      <li><a href="#workflow">Workflow</a></li>
      <li><a href="#session-info">Session Info</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Matt Jones, Tal Ashuach, David Detomaso.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
